name: Security Sidecar Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  security-check:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: lts/*

    - name: Install Dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    # Docker igual na máquina
    - name: Start ZAP Sidecar (Docker)
      run: |
        docker compose up -d
        echo "⏳ Esperando o ZAP iniciar..."
        sleep 15

    # Rodamos o script
    - name: Run Tests & Security Scan
      run: node run-security.js

    # Salvamos o relatório para baixar
    - name: Upload Security Report
      if: always() # Roda mesmo se o teste falhar
      uses: actions/upload-artifact@v4
      with:
        name: zap-security-report
        path: security-report.html
        retention-days: 30